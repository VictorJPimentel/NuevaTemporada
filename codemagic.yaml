workflows:
  android-workflow:
    name: Android Workflow
    max_build_duration: 120
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default
    scripts:
      - name: Set up key properties
        script: |
          echo $FCI_KEYSTORE | base64 --decode > /tmp/keystore.keystore
          cat >> "$FCI_BUILD_DIR/android/key.properties" <<EOF
          storePassword=$FCI_KEYSTORE_PASSWORD
          keyPassword=$FCI_KEY_PASSWORD
          keyAlias=$FCI_KEY_ALIAS
          storeFile=/tmp/keystore.keystore
          EOF
      - name: Set up local.properties
        script: |
          echo "flutter.sdk=$HOME/programs/flutter" > "$FCI_BUILD_DIR/android/local.properties"
      - name: Get Flutter packages
        script: |
          cd . && flutter packages pub get
      - name: Flutter analyze
        script: |
          cd . && flutter analyze
      - name: Flutter unit tests
        script: |
          cd . && flutter test
        ignore_failure: true          
      - name: Install pods
        script: |
          find . -name "Podfile" -execdir pod install \;
      - name: Build APK with Flutter  
        script: |
          cd . && flutter build apk --release --build-name=1.0.0 --build-number=$(($(google-play get-latest-build-number --package-name "$PACKAGE_NAME" --tracks="$GOOGLE_PLAY_TRACK") + 1))
    artifacts:
      - build/**/outputs/**/*.apk
      - build/**/outputs/**/*.aab
      - build/**/outputs/**/mapping.txt
      - flutter_drive.log
    publishing:
      # See the following link for details about email publishing - https://docs.codemagic.io/publishing-yaml/distribution/#email
      email:
        recipients:
          - user_1@example.com
          - user_2@example.com
        notify:
          success: true     # To not receive a notification when a build succeeds
          failure: false    # To not receive a notification when a build fails
      slack: 
        # See the following link about how to connect your Slack account - https://docs.codemagic.io/publishing-yaml/distribution/#slack
        channel: '#builds'
        notify_on_build_start: true   # To receive a notification when a build starts
        notify:
          success: true               # To not receive a notification when a build succeeds
          failure: false              # To not receive a notification when a build fails
      google_play:
        credentials: Encrypted(Z0FBQUFBQmd1dERzcGRoeWlPWFZLWTdlM0lzNlUzUEg2Y3prdVVjWUpMRWZsWVhfX19XaGVkcFJvNmx6NTZTWGYtREVUeGpCSk1kRXBOd3F2bnZqQ0VHUlVUY3ZhOFJKWDhCSHl3bUpkQm16NUFGU1BPc3VGQl94NXIxTXlBdEtPbHBobk1NSnVqS3owWlk4Q1h3M285QWp2dXJEODE4YS1ZZW9hZGE3dlh4RTE1U1lYSmNORUJ2cDZObnNrMU1oY3dUejQ5N2JpWWF1QkVSM2VQWHcwdW84YlF6RUNFQ01DbWV1RWVEUVVzTU9rOXoxbF9nelY2RXlPcHRpX0lobnoyeWRmOTR1YXlfdTJhRnhtWDlONzZYNmJOWllyNzJiQTlMR2M3OHJSSWY2aS1oNGZQOGJHaUJNZXFISjJRWklQOVVoSy0tNlN3NXE2NVd0QnhFYjl4eTJwSEczSWZPLTNwcXNnX2RzdnRZbWx1TVo5c3BqQXZxVi1aMThfanNVR3V2LVhiMl9NalJhME1nR01ib2xvQlRPVzNhM1BBelpXT3FyQW1la1lWMmZIbm9rRmFwV09nNHdROTZ2VHQ1TThZTlMwdGxZemlTRVFrMy1ackxTc2RNekppS0xaS1V3aUdhZzZCejk4RjA5enFoMTdNdGdSRnlxUEU5bnhHWmRvc3RLRWZwbkRXODAzYTZRM0p5MnJMN2g1SjRLVVhiVU1sdnRLemZYNktYXy1QZXpHRnl0UmJDX3IxbmJYQkFwcTVXem1SLVR0Um4zdjIyQWNhNnNKYWFpN0ZSWXBJV050UHNjRVljRXlYQ1BZMVRVUEZHNlFoM3lycXJFbzR1NVdZd0xaR0piYWhWclA5TDZaOVEwMjRaU0xJakpRblR2SVBnN0hqSkxBZUVIOEFIbWdBcmROTFd0NERjbnJ6VVMzYm1NWlJHbVZYZGlNRkFOS1ZqRWRieEFWazdma3VMUk9PNUk4WWZ1V2hsMFd1d0EwRzB5enBLdWV2RkRnU1Jzd2tWOXNvWDhDTTZWZVY1RFg3U080RXZtVVhPb2t6WjBubml3dW9pcEVFM1ZlYXJNTjRxOXNwOVJxYU8tUlFUMVdvVjVNTTFVcWVwN2NyR3lMdklUOEp3dmRzbUg1c09HeHJUUTVMMUdZdkVJejVZU2s3QVdnT1BxS1BsYUQ0ZEQyc1ZXajVLVEpWUXBfX3U0OUtrdm5VeXc4blBSVmMybG44a3N3OHN0M3dvb29fNDlISjVlTmRKQkZINF9iYmpPV19uZEVGdm9KV1JJdmVWWGFXNzNGVXBISkxEU2FNRHNYblEzUzhPVml4U3h0QWJIdDIzcnFsU1hwWVZaTGVfU01SVXdwczVIQ0RYN3kyUmVhU3BoOGlFczB1c3FZUjBCOXdMUXNmSUFLaEVGS0ZXMXl5WURDbU82LVlzenotcHh3R2dXYlNSLVY1TVFOd1BLQU9ZZHZKcks2Z01WekZ3Vm1BSGU0SndYYzRFdEFhRGhjNGhIYXBQaUhiakdwZnlMVURRNkhqc0x2QnVjX1Z2YndndmJtZ3BSczhWNHhLUnl1RGdWQkFrN19odHMzMk43YkZxYWhqS1gtQ2VONE9ScjFkOFFHRVpQLXpZNFRBQjRoelFQOWQ3eEZweW4wWTlCQnA0MnRyWUFHTGFXV2FGZW9rRkNndzdhaTNDWFZOOGFrT2pKbVNCNERGb3VQcnNfaF9tN2NTNmlzTkJPTVB3OG0yWF9DQjdqMUlyV1hlMlQ5LTBlTllJQVQ2cWpiY1h4WENUU1kxVm5rM0FMcWJLSnNxYkI2QzZxdUFqWEJrb0c4S1RyUko3UFBfbE94cUxjbWJiOWJETEFleV9xWlAxQUdLV1owUHFQVU9EZk5vQXdBc3ZtQ2FJeWluejJOdDIwOHpKYWw3aGFCTlpoMHJkVVozNjlzT2NLYzZ0WnNZbGlMWU1WdFlFdHdDcFhoQV9HRkEwWVNDX2hsSXpvRmx4bXJDZXBNUm5wNE1BWERLRm91TWxScEFvMjAtOVR2N2JOSldZd25VSzVFYXhzdVd2Z3RxTnZfSUJQVjROY2xJdUZkYnZUb2hYeXFXWV9xaURCbEdKcS1FNDZLR1c0VzlhVlY5R3F1T0FoTENNUGJBTmdqYUc1SFB1N1BqOV9rUW50QnpmTGF2eVNXckVZc25ob0RPejhDYXV1Q3I2NG8yOWEwdFlWMWRoS21jeGtDTlBVcnhUYnFCNHBhTU9XOGVwV2tLMC1jakxiWnFoV1R4TWt1c3lHWE9JRVhLQ1UtVEo5NWw3blBSZVRpWGN4SWlIckxKUlJPRVBkZFFCVVZRNGtHT3E4YmpHeXNka0p6T190S1N2ZVhCX29uZS14YWpQczRUd3FDWC05d3dheC0zMk1fc3ZOdVlPY0VseHQySFBqMHphcUZocnV2NVpzUEtxNzg0cjVOci05WnBOZTF6SUIyRDhqVVJUTS1ReFphNEFPZmlnYVNIVWVVNzdVQUFOZkctM3pXdklUQk9qcUFDWGtJM3dtQXpGVjc4eDdMdy1JWWxKazFoamhKRUM0dlNIa2NxOGlxVFJ0YzFRV19JZ21DcUZXNnA5Ullpb2xJa2JJSTRUZWFxMmMxUmJWZjlEUTdMQ2hNVi0tLXduOXNNMjdZTTgxYm4wN1ZkbDhnRWJBRDRIS0Y5SWdCV3pwc3R4LVIzWEIzcVhjNExXdm9hRFRPdk9taG1NSXNhMU1hdUtHT0hYRnJORWN3THVaem11Q1JxbFpnSHBEREtIWHdjRENOc3NWSHFMa01UbU5rRzNDZFBaSVNuTjFMaU9ObjYyRlQ0LWVqdzZ5eXRZTGw0TGdranVrME16UHFXMi1uNHVLZWJJZE1odmV2el92R1VhemQ2R0pDakROUTV4bURNUGg3ejFqYXNXS1UzWUVpd0Y3Y1RaVTdvTmhjYnVKMTRqZ1MtX0UwNmx3MFl5dGkyZDVGYnMyMi1JYUptbWx5T1V6V2VOZnhrR0tHM3MtSlgtOUQ4cHdkUGxSSC1laDYzcWpiSVltNEZxSzJ5TVBsQmlaeFVZb2Rwa3dPTk1mZm5DZnZuVmdWVFZRSkE2YzIzRDJ0eUtwczI5Q3ZXTTE4UVg5R0RpQk12aWFxejlycHpwX0NZeEZ0QVV2Sk10V2o0NVBLdWFFOGVQTElKOTRSU0NLSTRyQzRfXzVGV3Vmc3JVbVphLVlQcklBYjloVmZZQlpfRmlKUWdJRnlNMzlvcEpadXFLRTZJdXNjYVJMTnMxOWU4akVLeFpocVNrSE1UdUhaTDl2VEp4LVdRTUxZMnZqaElKYVZuUWV4Y2hZN3l1UkFRdnZYd3FWbDdRNXNYSWk5S1ppMmRnTFdrNjJ3YUk3RGZwbkhsSzlhT040dXhOQlI5Y2ExZnZPZ3hxNmd2U0szVUZCZmJIeTl2a0FtNmdfWXctUEg0aWNXcUg2LXpLcGdHVHpzcnBEdWM0SkFEaDB0VDByOE8tdElidVdsRF9NeTdaTHhiQ3hEbWp1Wk1Nb2lacVZySmVjRVJBZTc2MWREWEREdUJ4bGRfeFVwSkhBS0tLRVBlN2NGWnk4RkxiWFprdjZuc1lYZHNTR3o2M0FlRVlIRzB6UFhmZWlWTml0SUM5R2NzZFhkd0VvSlBPVGV5RHI2M2c0QXRPWTRBZGNLakhGdkx5VVhrQk5sZm1NeEJxVDhlLUxNOEpVOXdIVWlXLWtwQWR2OFBzUHF6bE1Ndk5rVDhDTmJzRTJqbG5jN01tSXFTRjZGX3RzMFdBWXo1alh0eFdyQWtUOFFSYUl1aGpQM3VlZUh5ZEdsTExaOUlFTFRuSHgxUDB3M1Q0OTJaVDZOV05SSEdLRHI4NjdrNGE1VTFPZ2FwaW5kLTlmWTJGWjZycUVtRC1sYW9lN2N6NGhRVHQ4dlRjRGJHSEFjVWpaNWJvaVpWLWQyZzdRYnBJeXZKdm1wS0J0bVhWLThDbjBaeDZHc1JoWGlEYzVNYXJ0TlREM2VPRXR4cjdXNFFnbmV6bEp5SWVXRG55X3ZEMXQxY2NjMFV1QjdHWWZVYmxhRENIdFVhVjBWTmtYbVpzekQybHlCME96X2pnNnBGMlhzM3FaSWlRTXBfX1JiRFEzMlFEdWRrQ3I3VjZqVWQ0NkFiZ0ZfbjI0T29uTi16SDVpVkd3ZGpyR1RZbGhVV1lob2o4aWxTUGNWR2N6ZFNsTXNVNVdpNFZwLXVPa0ZkUzE5eHpWdnY1V2xrNUZ1SGxBMjJRYy1Cc0g0eHkxYzJ5QkJZZHpfb1JSb1k1RUtGbmJjcVZTdktvbWNVNVFLTmhUbGs1cFlsRFlleWZaQkc0b0lFMHRaNFRfZThhWE8xREd2ZDd1M1Z4YnBoUUZyMkJ3SHJELTNrT3hzc3BLM3YyYVpSSmRmUGd6TGo2NjU5SDhjcUNXS3pvcmEwZG8zQnhDNkQwSS10VDVZeHBUTmxYNTNnQmhNMm5JQllSSzRVM19nN0dRZTZwMmtWcEhQMnN5Qm82d3JKQlgyUVVGZzMySE9pRUVRaFpBRHRfQU9EcVdKcU81UllydUpLeXktcXBhajgyNEJLajVvYmtzYmRESmFKRTlvQ1dsUGJVZzVPdE81XzlXa3Y3cFR3WHRpOE1FdEl4MGE1ajJWaW9weDdYSU9ZMUUwVUxSNWs1akZ4T1ppYTJXUnB2b3ZpQmlsZnNhQXJUX1dzVUJ3Y3lBdC1nXzZ0VS0waFhvMUFYMjd5UU1nYWJmT0d3MnQ2Y25YWjJPSDNZb3g2NFVGRU1Bd1FIUmZkbF93T0JqczhlLWZCOS05MDBXWmxnUHJHbmQ5Wnl2X2xTLUZfeEJzMG9kTTRFYXM3MGRDbVRWRkZxNnhVVm5lRGdLQmtfa0NBWXZDbmR4aEo2ZzZlZGNFTmpGRzdTYUFwQlhzMHhXNmRXQVdycGVzTTJvUUg3OUZIRURnUzZFdGlMWHREc0swYVVEbWVVZS15c3NWWFpORVZBU0FocGVGeTloaGhNWk9NSFYtSTA5anJQaDF5WnozcmRpcFpGVlZDLWhrR3RrZGtlTmprQmhtSFF2ellKZG9DX2hGQ242UjZpZVZodGQ1SDhaZkY5aTNRUkxacVAyckhkVUpxNlhfX00yMGFZakZKX2UwX2VYbzFTdklQVnhOdVNSYzh2MHZYakFRYm1XeGY3a0t1TWRRSUxUYkJqZktKUWY2ZGFaSWltTnZuNkd0Si1VT0p3aF9Pd21uUl9LQWVsS1FXNnZvWkVxTjJiWHdHeDAyWlVNdlFxdmdVb0FuWjlpVzNRM0MxcElOaWtxVVRLeHJhek1wMmRvWGVuNXZ6TmhxaUdPeTR6RzFTT3A1WElCWGxfZ2RYSlg4cW1Dc01SelpsZTF2U0dZaVRhS3QxZVRvRWhIZjZNYjJFSThjUndoclhDdnNXeE1XWUdaU1c0TVhpN0NCMzlUQWJJNExOMXBpLVFsOTk5Qk5LZmwwYVhUQVlDZS1peFBDQ2pWUUFxb0drS2U5bURqUGx5THNJM28tWmJCS2FPUzA4czNoaWFxLUY0bVNHNHZmZFlzVzNPeHZwNVZNMl9pTUtFYmhlQXNaelpWWm5NPQ==)
        track: alpha 
        in_app_update_priority: 0
  ios-workflow:
    name: iOS Workflow
    # instance_type: mac_mini
    max_build_duration: 120
    environment:
      vars:
        XCODE_WORKSPACE: "Runner.xcworkspace"
        XCODE_SCHEME: "Runner"                
      flutter: stable
      xcode: latest
      cocoapods: default
    scripts:
      - name: Set up keychain to be used for codesigning using Codemagic CLI 'keychain' command
        script: |
          keychain initialize
      - name: Fetch signing files
        script: |
          app-store-connect fetch-signing-files $BUNDLE_ID --type IOS_APP_STORE --create
      - name: Use system default keychain
        script: |
          keychain add-certificates
      - name: Set up code signing settings on Xcode project
        script: |
          xcode-project use-profiles
      - name: Get Flutter packages
        script: |
          cd . && flutter packages pub get
      - name: Flutter analyze
        script: |
          cd . && flutter analyze
      - name: Flutter unit tests
        script: |
          cd . && flutter test
        ignore_failure: true          
      - name: Install pods
        script: |
          find . -name "Podfile" -execdir pod install \;
      - name: Flutter build ipa and automatic versioning
        script: |
          flutter build ipa --release \
          --build-name=1.0.0 \
          --build-number=$(($(app-store-connect get-latest-testflight-build-number "$APP_STORE_ID") + 1)) \
          --export-options-plist=/Users/builder/export_options.plist
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    publishing:
      # See the following link for details about email publishing - https://docs.codemagic.io/publishing-yaml/distribution/#email
      email:
        recipients:
          - user_1@example.com
          - user_2@example.com
        notify:
          success: true     # To receive a notification when a build succeeds
          failure: false    # To not receive a notification when a build fails
      slack: 
        # See the following link about how to connect your Slack account - https://docs.codemagic.io/publishing-yaml/distribution/#slack
        channel: "#builds"
        notify_on_build_start: true   # To receive a notification when a build starts
        notify:
          success: true               # To receive a notification when a build succeeds
          failure: false              # To not receive a notification when a build fails
      app_store_connect:   # https://docs.codemagic.io/publishing-yaml/distribution              
        apple_id: $APPLE_ID    
        password: $APPLE_APP_SPECIFIC_PASSWORD
